<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture Image and Video and Upload to Azure Blob Storage</title>
    <style>
        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
            border: 1px solid #ddd;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
        }
        .thumbnail-wrapper {
            position: relative;
            display: inline-block;
        }
        .remove-button {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
    <!-- Include Compressor.js library -->
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.0.7/dist/compressor.min.js"></script>
</head>
<body>
    <label for="cameraInput" class="custom-file-upload">Capture Image with Camera<span id="cameraFileName"></span></label>
    <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display: none;" onchange="handleFiles(this.files, 'image'); updateFileName('cameraInput', 'cameraFileName');" multiple>
    <br><br>
    <label for="videoInput" class="custom-file-upload">Capture Video with Camera<span id="videoFileName"></span></label>
    <input type="file" accept="video/*" capture="environment" id="videoInput" style="display: none;" onchange="handleFiles(this.files, 'video'); updateFileName('videoInput', 'videoFileName');" multiple>
    <br><br>
    <label for="fileInput" class="custom-file-upload">Select Image or Video from Library<span id="fileName"></span></label>
    <input type="file" accept="image/*,video/*" id="fileInput" style="display: none;" onchange="handleFiles(this.files); updateFileName('fileInput', 'fileName');" multiple>
    <br><br><br><br>

    <div class="thumbnail-container" id="thumbnailContainer"></div>

    <form action="/other" method="POST">
        <input type="hidden" id="imageUrlInput" name="imageUrl">
        <button type="submit">Log Asset Checked</button>
    </form>

    <script>
        let uploadedMediaUrls = [];
        let mediaFiles = [];

        function updateFileName(inputId, fileNameId) {
            var input = document.getElementById(inputId);
            if (!input) {
                console.error('Element with ID', inputId, 'not found');
                return;
            }
            var fileName = input.value.split('\\').pop();
            var fileNameElement = document.getElementById(fileNameId);
            if (fileNameElement) {
                fileNameElement.textContent = " - " + fileName;
            } else {
                console.error('Element with ID', fileNameId, 'not found');
            }
        }

        function handleFiles(files, type) {
            for (let file of files) {
                console.log('Original file size:', file.size);
                if (type === 'image' || file.type.startsWith('image/')) {
                    // Compress the image
                    new Compressor(file, {
                        quality: 0.6,
                        success(result) {
                            console.log('Compressed file size:', result.size);
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                const imageUrl = event.target.result;
                                displayThumbnail(imageUrl, result, 'image');
                            };
                            reader.readAsDataURL(result);
                        },
                        error(err) {
                            console.error('Image compression error:', err);
                        },
                    });
                } else if (type === 'video' || file.type.startsWith('video/')) {
                    // Handle video file
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const videoUrl = event.target.result;
                        displayThumbnail(videoUrl, file, 'video');
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function displayThumbnail(mediaUrl, file, type) {
            const container = document.getElementById('thumbnailContainer');
            const wrapper = document.createElement('div');
            wrapper.className = 'thumbnail-wrapper';

            let mediaElement;
            if (type === 'image') {
                mediaElement = document.createElement('img');
                mediaElement.src = mediaUrl;
                mediaElement.className = 'thumbnail';
            } else if (type === 'video') {
                mediaElement = document.createElement('video');
                mediaElement.src = mediaUrl;
                mediaElement.className = 'thumbnail';
                mediaElement.controls = true;
            }

            const button = document.createElement('button');
            button.className = 'remove-button';
            button.innerText = 'X';
            button.onclick = function() {
                container.removeChild(wrapper);
                const index = mediaFiles.indexOf(file);
                if (index > -1) {
                    mediaFiles.splice(index, 1);
                    uploadedMediaUrls.splice(index, 1);
                }
            };

            wrapper.appendChild(mediaElement);
            wrapper.appendChild(button);
            container.appendChild(wrapper);

            mediaFiles.push(file);
            uploadMedia(file, type).then(url => {
                uploadedMediaUrls.push(url);
                document.getElementById('imageUrlInput').value = uploadedMediaUrls.join(';');
            }).catch(error => {
                console.error('Upload failed:', error);
                alert('Failed to upload media. Please try again.');
            });
        }

        const storageAccountName = 'firstfire';
        const containerName = 'firedoors1';
        const sasToken = "?sv=2022-11-02&ss=bfqt&srt=o&sp=rwdlacupiytfx&se=2025-05-01T11:30:24Z&st=2024-11-03T02:30:24Z&spr=https&sig=3uRVgEz%2BaObXlwv3iR%2FRHM73GZHmVQHBcH0wtGFOFnc%3D";

        async function uploadMedia(file, type, retries = 3) {
            const blobName = `${type}_${Date.now()}.${type === 'image' ? 'jpg' : 'mp4'}`;
            const url = `https://${storageAccountName}.blob.core.windows.net/${containerName}/${blobName}${sasToken}`;

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob',
                        'Content-Type': file.type,
                        'x-ms-version': '2020-04-08'
                    },
                    body: file
                });

                if (response.ok) {
                    console.log('Upload successful:', url);
                    return url;
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Error during fetch:', error);
                if (retries > 0) {
                    console.log(`Retrying upload... (${retries} retries left)`);
                    return uploadMedia(file, type, retries - 1);
                } else {
                    throw error;
                }
            }
        }

        document.querySelector('form[action="/doors"]').addEventListener('submit', function(event) {
            event.preventDefault();
            const imageUrlInput = document.getElementById('imageUrlInput');
            imageUrlInput.value = uploadedMediaUrls.join(';');
            this.submit();
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
        });
    </script>
</body>
</html>